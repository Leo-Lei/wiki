---
layout: post
title: NAT
date: 2017-05-20 14:00:00
tags:
- Java
categories: Java
---

# 1. Overview
NAT(Network Address Translation)网络地址转换。说白了就是修改报文的IP地址。nat功能通常被集成到路由器，防火墙或独立的nat设备中。为什么要修改报文的ip地址呢？有如下两个典型的场景：
1. 让私网IP可以访问互联网
2. 让互联网可以访问私网ip

让私网IP可以访问互联网
整个公司只有一个公网IP，有10台电脑。这10台电脑如何访问互联网呢？
当网络内部的主机向网络外主机发送报文时，报文会经过防火墙或路由器。当报文经过防火墙或路由器时，将报文的源IP修改为防火墙或者路由器的ip地址。当其他网络主机收到这些报文时，显示的源ip地址是路由器的或防火墙的ip地址，而不是那10台主机的ip地址。当网络内主机的报文经过路由器时，路由器会维护一张nat表，表中记录了报文来自于哪个内部主机的哪个进程（内部主机ip+端口）。当报文经过路由器，路由器会将报文的内部主机源IP替换为路由器的ip地址，把源端口也映射为某个端口，nat表会把这种对应关系记录下来。

```text
源ip，源port，目标ip，目标port            ---------------->          路由ip，映射后port，目标ip，目标port
```

于是，外部主机接收到报文时，源ip与源端口显示的都是路由的ip和端口。当外部主机进行相应时，将响应报文发送到路由器。路由器是有公网ip的，外部网络主机是可达的。路由器再根据刚才nat表中的映射记录，将响应报文中的目标ip和目标端口再改为内部主机的ip和端口，然后再将响应报文发送给内部网络的主机。整个过程，外部主机都不知道内部主机的ip，内部主机也可以访问外部主机，这同时也起到了隐藏内部主机ip的作用。
上述过程中，用到了nat功能。ip地址的转换一共发生了两次。
内部网络的报文发送出去时，报文的源ip会被修改，也就是源地址转换：source network address translation，缩写为snat
外部网络的报文响应时，响应报文的目标ip会再次被修改，也就是目标地址转换：destination network address translation，缩写为dnat。
但是上述整个过程被称为SNAT，因为前半段使用了snat。如果上述整个过程的前半程使用了dnat，则整个过程称为dnat。也就是说，整个过程被称为snat还是dnat，取决于整个过程的前半段使用了snat还是dnat。


如果在局域网中部署了一个web server或数据库server，想让外网的机器能够访问内网中的web server，也必须要做和上面类似的流程。但是反过来的，前面是dant，后面是snat。





私有iP地址块:    
* A 类：10.0.0.0～10.255.255.255
* B 类：172.16.0.0～172.31.255.255
* C 类：192.168.0.0～192.168.255.255




